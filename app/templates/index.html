{% extends "base.html" %}

{% block title %}Dashboard - Afterwatch{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="loadStats()">
    <h1>Dashboard</h1>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" x-text="stats.total_episodes_processed">-</div>
            <div class="stat-label">Episodes Processed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="stats.total_gb_reclaimed + ' GB'">- GB</div>
            <div class="stat-label">Space Reclaimed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="stats.last_run ? stats.last_run.status : 'Never'">-</div>
            <div class="stat-label">Last Run Status</div>
        </div>
        <div class="stat-card" :class="{ 'warning': stats.dry_run_enabled }">
            <div class="stat-value" x-text="stats.dry_run_enabled ? 'ON' : 'OFF'">-</div>
            <div class="stat-label">Dry Run Mode</div>
        </div>
    </div>
    
    <div class="actions-panel">
        <h2>Actions</h2>
        <button 
            @click="runProcess()" 
            :disabled="processing"
            class="btn btn-primary"
        >
            <span x-show="!processing">Run Now</span>
            <span x-show="processing">Processing...</span>
        </button>
        <p class="action-note" x-show="stats.dry_run_enabled">
            ⚠️ Dry run mode is enabled. Processing will simulate actions without making changes.
        </p>
    </div>
    
    <div class="recent-activity" x-show="stats.last_run">
        <h2>Last Run</h2>
        <table class="data-table">
            <tr>
                <th>Time</th>
                <td x-text="stats.last_run ? new Date(stats.last_run.timestamp).toLocaleString() : '-'"></td>
            </tr>
            <tr>
                <th>Status</th>
                <td x-text="stats.last_run ? stats.last_run.status : '-'"></td>
            </tr>
            <tr>
                <th>Episodes</th>
                <td x-text="stats.last_run ? stats.last_run.episodes : '-'"></td>
            </tr>
            <tr>
                <th>Mode</th>
                <td x-text="stats.last_run && stats.last_run.dry_run ? 'Dry Run' : 'Live'"></td>
            </tr>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        stats: {
            total_episodes_processed: 0,
            total_gb_reclaimed: 0,
            last_run: null,
            dry_run_enabled: true
        },
        processing: false,
        
        async loadStats() {
            try {
                const response = await fetch('/api/stats');
                this.stats = await response.json();
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        },
        
        async runProcess() {
            this.processing = true;
            try {
                const response = await fetch('/api/process', { method: 'POST' });
                const result = await response.json();
                alert(result.dry_run 
                    ? 'Processing started (dry run mode)' 
                    : 'Processing started');
                // Refresh stats after a delay
                setTimeout(() => this.loadStats(), 5000);
            } catch (e) {
                alert('Failed to start processing: ' + e.message);
            } finally {
                this.processing = false;
            }
        }
    }
}
</script>
{% endblock %}
