{% extends "base.html" %}

{% block title %}Dashboard - Afterwatch{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div x-data="dashboard()" x-init="loadStats()">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" x-text="episodes">0</div>
            <div class="stat-label">Episodes Processed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="space">0 GB</div>
            <div class="stat-label">Space Reclaimed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="status">Never</div>
            <div class="stat-label">Last Run Status</div>
        </div>
        <div class="stat-card" :class="{ 'warning': dryRun }">
            <div class="stat-value" x-text="dryRun ? 'ON' : 'OFF'">OFF</div>
            <div class="stat-label">Dry Run Mode</div>
        </div>
    </div>

    <section class="actions-section">
        <h2>Actions</h2>
        <button class="btn btn-primary" @click="runNow()">Run Now</button>
        <p class="warning-text" x-show="dryRun">
            âš  Dry run mode is enabled. Processing will simulate actions without making changes.
        </p>
    </section>
</div>

<section class="last-run-section" x-data="lastRun()" x-init="loadLastRun()">
    <h2>Last Run</h2>
    <template x-if="run">
        <div class="last-run-details">
            <div class="detail-row">
                <span class="detail-label">Time</span>
                <span class="detail-value" x-text="run.started_at"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value" x-text="run.status"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Episodes</span>
                <span class="detail-value" x-text="run.episodes_processed"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Mode</span>
                <span class="detail-value" x-text="run.dry_run ? 'Dry Run' : 'Live'"></span>
            </div>
        </div>
    </template>
    <template x-if="!run">
        <p class="empty-state">No runs yet.</p>
    </template>
</section>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        episodes: 0,
        space: '0 GB',
        status: 'Never',
        dryRun: false,
        
        async loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                this.episodes = data.episodes_processed || 0;
                this.space = data.space_reclaimed || '0 B';
                this.status = data.last_run_status || 'Never';
                this.dryRun = data.dry_run || false;
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        },
        
        async runNow() {
            try {
                await fetch('/api/process', { method: 'POST' });
                window.location.href = '/logs/';
            } catch (e) {
                alert('Failed to start processing: ' + e.message);
            }
        }
    }
}

function lastRun() {
    return {
        run: null,
        
        async loadLastRun() {
            try {
                const response = await fetch('/api/last-run');
                if (response.ok) {
                    this.run = await response.json();
                }
            } catch (e) {
                console.error('Failed to load last run:', e);
            }
        }
    }
}
</script>
{% endblock %}
