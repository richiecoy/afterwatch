{% extends "base.html" %}

{% block title %}Logs - Afterwatch{% endblock %}

{% block content %}
<h1>Processing Logs</h1>

<!-- Recent Runs -->
<section class="logs-section">
    <h2>Recent Runs</h2>
    {% if runs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Started</th>
                <th>Status</th>
                <th>Trigger</th>
                <th>Episodes</th>
                <th>Reclaimed</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr>
                <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <span class="status-badge {{ 'success' if run.status == 'completed' else 'error' if run.status == 'failed' else 'pending' }}">
                        {{ run.status }}
                    </span>
                </td>
                <td>{{ run.trigger }}</td>
                <td>{{ run.episodes_processed }} / {{ run.episodes_processed + run.episodes_failed }}</td>
                <td>{{ format_size(run.bytes_reclaimed) }}</td>
                <td>{{ 'Dry Run' if run.dry_run else 'Live' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No runs yet.</p>
    {% endif %}
</section>

<!-- Episode Logs -->
<section class="logs-section" x-data="episodeLogs()">
    <h2>Episode Log</h2>
    
    <!-- Filters -->
    <form method="GET" class="filters-form">
        <input 
            type="text" 
            name="series" 
            value="{{ series_filter or '' }}"
            placeholder="Filter by series..."
            class="filter-input"
        >
        <select name="success_only" class="filter-select">
            <option value="">All Results</option>
            <option value="true" {% if success_filter == true %}selected{% endif %}>Success Only</option>
            <option value="false" {% if success_filter == false %}selected{% endif %}>Failures Only</option>
        </select>
        <button type="submit" class="btn btn-secondary">Filter</button>
    </form>
    
    {% if logs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Series</th>
                <th>Episode</th>
                <th>Folder</th>
                <th>Size</th>
                <th>Watched By</th>
                <th>Status</th>
                <th>Mode</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr id="log-row-{{ log.id }}">
                <td>{{ log.series_name }}</td>
                <td>S{{ '%02d'|format(log.season_number) }}E{{ '%02d'|format(log.episode_number) }}</td>
                <td>{{ log.folder_name or '-' }}</td>
                <td>{{ format_size(log.original_size_bytes) }}</td>
                <td>{{ log.watched_by or '-' }}</td>
                <td>
                    {% if log.success %}
                    <span class="status-badge success">✓</span>
                    {% else %}
                    <span class="status-badge error" title="{{ log.error_message }}">✗</span>
                    {% endif %}
                </td>
                <td id="mode-{{ log.id }}">{{ 'Dry' if log.dry_run else 'Live' }}</td>
                <td>
                    {% if log.dry_run and log.success %}
                    <button 
                        class="btn btn-small btn-primary"
                        id="btn-{{ log.id }}"
                        @click="processSingle({{ log.id }})"
                    >
                        Process
                    </button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&series={{ series_filter or '' }}&success_only={{ success_filter or '' }}" class="btn btn-secondary">← Previous</a>
        {% endif %}
        <span>Page {{ page }}</span>
        {% if logs|length == per_page %}
        <a href="?page={{ page + 1 }}&series={{ series_filter or '' }}&success_only={{ success_filter or '' }}" class="btn btn-secondary">Next →</a>
        {% endif %}
    </div>
    {% else %}
    <p class="empty-state">No episodes processed yet.</p>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
function episodeLogs() {
    return {
        async processSingle(logId) {
            const btn = document.getElementById(`btn-${logId}`);
            const modeCell = document.getElementById(`mode-${logId}`);
            
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                const response = await fetch(`/logs/process-single/${logId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    btn.textContent = 'Done!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    modeCell.textContent = 'Live';
                } else {
                    btn.textContent = 'Failed';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-error');
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                btn.textContent = 'Error';
                btn.classList.add('btn-error');
                alert('Error: ' + e.message);
            }
        }
    }
}
</script>
{% endblock %}
