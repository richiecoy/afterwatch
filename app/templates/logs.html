{% extends "base.html" %}

{% block title %}Logs - Afterwatch{% endblock %}

{% block content %}
<h1>Processing Logs</h1>

<!-- Recent Runs -->
<section class="logs-section" x-data="runsSection()">
    <h2>Recent Runs</h2>
    {% if runs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Started</th>
                <th>Status</th>
                <th>Trigger</th>
                <th>Episodes</th>
                <th>Reclaimed</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr>
                <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    {% if run.status == 'running' %}
                    <span class="status-badge pending" x-text="progressText">
                        running
                    </span>
                    {% else %}
                    <span class="status-badge {{ 'success' if run.status == 'completed' else 'error' }}">
                        {{ run.status }}
                    </span>
                    {% endif %}
                </td>
                <td>{{ run.trigger }}</td>
                <td>
                    {% if run.status == 'running' %}
                    <span x-text="episodesText">{{ run.episodes_processed }} / {{ run.episodes_processed + run.episodes_failed }}</span>
                    {% else %}
                    {{ run.episodes_processed }} / {{ run.episodes_processed + run.episodes_failed }}
                    {% endif %}
                </td>
                <td>
                    {% if run.status == 'running' %}
                    <span x-text="reclaimedText">{{ format_size(run.bytes_reclaimed) }}</span>
                    {% else %}
                    {{ format_size(run.bytes_reclaimed) }}
                    {% endif %}
                </td>
                <td>{{ 'Dry Run' if run.dry_run else 'Live' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No runs yet.</p>
    {% endif %}
    
    <div class="export-actions">
        <a href="/api/export-failures" class="btn btn-secondary">Export Failures (CSV)</a>
    </div>
</section>

<!-- Pending Deletion -->
<section class="logs-section" x-data="pendingSection()" x-init="loadPending()">
    <h2>Pending Deletion</h2>
    <p class="help-text">Episodes watched and waiting for the <span x-text="delayDays"></span>-day delay period.</p>
    
    <template x-if="loading">
        <p>Loading...</p>
    </template>
    
    <template x-if="!loading && pending.length === 0">
        <p class="empty-state">No episodes pending.</p>
    </template>
    
    <template x-if="!loading && pending.length > 0">
        <div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Series</th>
                        <th>Episode</th>
                        <th>First Seen</th>
                        <th>Days Remaining</th>
                        <th>Process Date</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in pending" :key="item.id">
                        <tr>
                            <td x-text="item.series_name"></td>
                            <td x-text="'S' + String(item.season_number).padStart(2, '0') + 'E' + String(item.episode_number).padStart(2, '0')"></td>
                            <td x-text="item.first_seen_at"></td>
                            <td>
                                <span class="status-badge pending" x-text="item.days_remaining + ' days'"></span>
                            </td>
                            <td x-text="item.process_date"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </template>
</section>

<!-- Orphaned Files -->
<section class="logs-section" x-data="orphansSection()" x-init="loadOrphans()">
    <h2>Orphaned Files</h2>
    <p class="help-text">Files found in Emby but not tracked in Sonarr.</p>
    
    <template x-if="loading">
        <p>Loading...</p>
    </template>
    
    <template x-if="!loading && orphans.length === 0">
        <p class="empty-state">No orphaned files found.</p>
    </template>
    
    <template x-if="!loading && orphans.length > 0">
        <div>
            <div class="orphan-summary">
                <span x-text="orphans.length + ' orphaned files'"></span>
                <span> · </span>
                <span x-text="totalSize + ' can be reclaimed'"></span>
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Series</th>
                        <th>Episode</th>
                        <th>Folder</th>
                        <th>Size</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="orphan in orphans" :key="orphan.id">
                        <tr>
                            <td x-text="orphan.series_name"></td>
                            <td x-text="'S' + String(orphan.season_number).padStart(2, '0') + 'E' + String(orphan.episode_number).padStart(2, '0')"></td>
                            <td x-text="orphan.folder_name || '-'"></td>
                            <td x-text="orphan.size_formatted"></td>
                            <td>
                                <span class="status-badge" :class="orphan.exists ? 'pending' : 'error'" x-text="orphan.exists ? 'Exists' : 'Missing'"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <div class="orphan-actions">
                <button 
                    class="btn btn-danger" 
                    @click="deleteOrphans()"
                    :disabled="deleting"
                    x-text="deleting ? 'Deleting...' : 'Delete All Orphaned Files'"
                >
                </button>
            </div>
        </div>
    </template>
</section>

<!-- Episode Logs -->
<section class="logs-section" x-data="episodeLogs()">
    <h2>Episode Log</h2>
    
    <!-- Filters -->
    <form method="GET" class="filters-form">
        <input 
            type="text" 
            name="series" 
            value="{{ series_filter or '' }}"
            placeholder="Filter by series..."
            class="filter-input"
        >
        <select name="success_only" class="filter-select">
            <option value="">All Results</option>
            <option value="true" {% if success_filter == true %}selected{% endif %}>Success Only</option>
            <option value="false" {% if success_filter == false %}selected{% endif %}>Failures Only</option>
        </select>
        <button type="submit" class="btn btn-secondary">Filter</button>
    </form>
    
    {% if logs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Series</th>
                <th>Episode</th>
                <th>Folder</th>
                <th>Size</th>
                <th>Watched By</th>
                <th>Status</th>
                <th>Mode</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr id="log-row-{{ log.id }}">
                <td>{{ log.series_name }}</td>
                <td>S{{ '%02d'|format(log.season_number) }}E{{ '%02d'|format(log.episode_number) }}</td>
                <td>{{ log.folder_name or '-' }}</td>
                <td>{{ format_size(log.original_size_bytes) }}</td>
                <td>{{ log.watched_by or '-' }}</td>
                <td>
                    {% if log.success %}
                    <span class="status-badge success">✓</span>
                    {% else %}
                    <span class="status-badge error" title="{{ log.error_message }}">✗</span>
                    {% endif %}
                </td>
                <td id="mode-{{ log.id }}">{{ 'Dry' if log.dry_run else 'Live' }}</td>
                <td>
                    {% if log.dry_run and log.success %}
                    <button 
                        class="btn btn-small btn-primary"
                        id="btn-{{ log.id }}"
                        @click="processSingle({{ log.id }})"
                    >
                        Process
                    </button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}&series={{ series_filter or '' }}&success_only={{ success_filter or '' }}" class="btn btn-secondary">← Previous</a>
        {% endif %}
        <span>Page {{ page }}</span>
        {% if logs|length == per_page %}
        <a href="?page={{ page + 1 }}&series={{ series_filter or '' }}&success_only={{ success_filter or '' }}" class="btn btn-secondary">Next →</a>
        {% endif %}
    </div>
    {% else %}
    <p class="empty-state">No episodes processed yet.</p>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
function formatSize(bytes) {
    if (bytes >= 1024 ** 4) return (bytes / 1024 ** 4).toFixed(2) + ' TB';
    if (bytes >= 1024 ** 3) return (bytes / 1024 ** 3).toFixed(2) + ' GB';
    if (bytes >= 1024 ** 2) return (bytes / 1024 ** 2).toFixed(2) + ' MB';
    if (bytes >= 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return bytes + ' B';
}

function runsSection() {
    return {
        progressText: 'running',
        episodesText: '0 / 0',
        reclaimedText: '0 B',
        
        init() {
            this.pollProgress();
        },
        
        async pollProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                
                if (data.is_running) {
                    const total = data.total_count || '?';
                    const current = data.processed_count + data.failed_count;
                    
                    if (data.current_series) {
                        this.progressText = `running - ${data.current_series} ${data.current_episode} (${current}/${total})`;
                    } else {
                        this.progressText = `running (${current}/${total})`;
                    }
                    
                    this.episodesText = `${data.processed_count} / ${current}`;
                    this.reclaimedText = formatSize(data.bytes_reclaimed);
                    
                    setTimeout(() => this.pollProgress(), 2000);
                } else {
                    if (this.progressText !== 'running') {
                        window.location.reload();
                    }
                }
            } catch (e) {
                console.error('Failed to fetch progress:', e);
                setTimeout(() => this.pollProgress(), 5000);
            }
        }
    }
}

function orphansSection() {
    return {
        loading: true,
        orphans: [],
        totalSize: '0 B',
        deleting: false,
        
        async loadOrphans() {
            try {
                const response = await fetch('/api/orphans');
                const data = await response.json();
                this.orphans = data.orphans;
                this.totalSize = data.total_size_formatted;
            } catch (e) {
                console.error('Failed to load orphans:', e);
            } finally {
                this.loading = false;
            }
        },
        
        async deleteOrphans() {
            if (!confirm(`Delete ${this.orphans.length} orphaned files? This cannot be undone.`)) {
                return;
            }
            
            this.deleting = true;
            
            try {
                const response = await fetch('/api/delete-orphans', { method: 'POST' });
                const data = await response.json();
                
                alert(`Deleted ${data.deleted_count} files, reclaimed ${data.deleted_size_formatted}`);
                
                // Reload the orphans list
                await this.loadOrphans();
            } catch (e) {
                alert('Failed to delete orphans: ' + e.message);
            } finally {
                this.deleting = false;
            }
        }
    }
}

function episodeLogs() {
    return {
        async processSingle(logId) {
            const btn = document.getElementById(`btn-${logId}`);
            const modeCell = document.getElementById(`mode-${logId}`);
            
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                const response = await fetch(`/logs/process-single/${logId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    btn.textContent = 'Done!';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    modeCell.textContent = 'Live';
                } else {
                    btn.textContent = 'Failed';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-error');
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                btn.textContent = 'Error';
                btn.classList.add('btn-error');
                alert('Error: ' + e.message);
            }
        }
    }
}
</script>
{% endblock %}
